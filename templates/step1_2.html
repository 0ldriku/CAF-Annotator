<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transcription Service</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.css">
<style>
    .CodeMirror {
        border: 1px solid #ccc;
        height: auto;
        width: 100%;
    }
    .CodeMirror-scroll {
        max-height: 300px;  /* Adjust height accordingly */
    }
</style>
</head>
<body>
<div class="navbar">MARUKO</div>
<div class="container">
    <h1>1. Transcribe</h1>
    <h2>File Upload</h2>
    <p>Please upload the audio file</p>
    <form id="upload-form" enctype="multipart/form-data">
        <input type="file" name="audiofile" id="file-upload" accept="audio/*">
        <button type="submit">Upload and Transcribe</button>
    </form>
    <h2>Small segments of transcription</h2>
    <p>Edit the small segments (e.g., clause) by adding or deleting lines</p>
    <div id="editor-small-segment"></div> <!-- Placeholder for CodeMirror -->
    <button id="save-button-small-segment">Save and Next Step</button>
    
    <h2>Big segments of transcription</h2>
    <p>Edit the big segments (e.g., AS-unit) by adding or deleting lines</p>
    <div id="editor-big-segment"></div> <!-- Placeholder for CodeMirror -->
    <button id="save-button-big-segment">Save and Next Step</button>
</div>
<div class="container">
    <h1>2. Annotate</h1>
    <ul>
        <li>Adjust the segments in first track (the track below the audiowave).</li>
        <li>Adjust the boundaries of segments.</li>
        <li>Ensure you finished the step 1 and 2 then go nex step.</li>
        <li>Press the "Detect Silence" button to add pause segments in track 2. Once press the button, all segments in track 2 will be removed. It will auto detect mid-pause with a "M" markder and end-pause with a "E" marker.</li>
    </ul>
    <label>
        Zoom: <input type="range" id="zoom-slider" min="100" max="500" value="200" />
      </label>
      <button id="play-pause-btn">Play/pause</button>
      <div>
        <input type="file" id="subtitle-file" accept=".json"/>
        <button id="load-subtitles-btn">Load Transcription</button>
        <button id="save-region-data-btn">Save Region Data</button>
        <button id="silence-detection">Detect Silence</button>
      </div>
      
      <div class="waveform1-container">
        <div class="segment-button-container">
          <div class="track1placeholder"></div>
        </div>
        <div id="waveform1" class="waveform1"></div>
      </div>
      
      <div class="waveform-container">
        <div class="segment-button-container">
          <button id="addSegmentBtn2" class="segmentbutton">+ S-SEGT</button>
        </div>
        <div id="waveform2" class="waveform"></div>
      </div>
    
      <div class="waveform-container">
        <div class="segment-button-container">
          <button id="addSegmentBtn3" class="segmentbutton">+ B-SEG</button>
        </div>
        <div id="waveform3" class="waveform"></div>
      </div>
    
      <div class="waveform-container">
        <div class="segment-button-container">
          <button id="addSegmentBtn4" class="segmentbutton">+ PAUSE</button>
        </div>
        <div id="waveform4" class="waveform"></div>
      </div>
    
      <div class="waveform-container">
        <div class="segment-button-container">
          <button id="addSegmentBtn5" class="segmentbutton">+ ACCURACY</button>
        </div>
        <div id="waveform5" class="waveform"></div>
      </div>

      <div class="waveform-container">
        <div class="segment-button-container">
          <button id="addSegmentBtn6" class="segmentbutton">+ DYSY</button>
        </div>
        <div id="waveform6" class="waveform"></div>
      </div>

      <script type="module" src="{{ url_for('static', filename='js/step2.js') }}"></script>
</div>

<div class="container">
    <h1>3. Calculation</h1>
    <p>Calculate the results</p>
    <input type="file" id="regiondatajsonfileInput" accept=".json">
    <button onclick="loadFile()">Load File and Compute CAF</button>
    <div id="results"></div>
    <script src="{{ url_for('static', filename='js/computation.js') }}"></script>
</div>





<!-- below is the code editor for first container-->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.js"></script>
<script>
    $(document).ready(function() {
        var myCodeMirror_small_segment = CodeMirror(document.getElementById('editor-small-segment'), {
            value: 'Edit the small segments.\nThe transcription will be displayed here once the process is complete.\n...', // Ensure there's an initial newline for a    cleaner experience
            mode: "plaintext",
            lineNumbers: true,
            lineWrapping: true
        });
        var myCodeMirror_big_segment = CodeMirror(document.getElementById('editor-big-segment'), {
            value: 'Edit the big segments.\nThe transcription will be displayed here once the process is complete.\n...', // Ensure there's an initial newline for a    cleaner experience
            mode: "plaintext",
            lineNumbers: true,
            lineWrapping: true
        });
        // Enforce modifications only at spaces or end of lines
        myCodeMirror_small_segment.on('beforeChange', function(cm, change) {
            if (change.origin === "+input" || change.origin === "paste") {
                // Get the position and the line where the change is being made
                var line = cm.getLine(change.from.line);
                var charPos = change.from.ch;

                // Allow Enter only if it's at the end of a line or after a space
                if (change.text[0] === "\n") {
                    if (charPos === line.length || line[charPos - 1] === ' ') {
                        return; // Allow the newline
                    } else {
                        change.cancel(); // Prevent the newline
                        return;
                    }
                }
            }

            // Allow deletions only if they are complete lines
            if (change.origin === "+delete" || change.origin === "cut") {
                if (change.from.line !== change.to.line || // Multiple lines are being completely removed
                    (change.from.ch === 0 && change.to.ch === cm.getLine(change.from.line).length)) { // The whole line is being removed
                    return; // Allow line deletions
                } else {
                    change.cancel(); // Prevent partial line deletions
                }
            }

            // Handle normal typing and enforce no inline edits
            if (change.text[0] !== "\n" && change.from.line === change.to.line) {
                if (change.from.ch !== change.to.ch || (line.length !== 0 && line[change.from.ch - 1] !== ' ' && line[change.to.ch] !== ' ')) {
                    change.cancel(); // Prevent editing inside lines not at space boundaries
                }
            }
        });
        myCodeMirror_big_segment.on('beforeChange', function(cm, change) {
            if (change.origin === "+input" || change.origin === "paste") {
                // Get the position and the line where the change is being made
                var line = cm.getLine(change.from.line);
                var charPos = change.from.ch;

                // Allow Enter only if it's at the end of a line or after a space
                if (change.text[0] === "\n") {
                    if (charPos === line.length || line[charPos - 1] === ' ') {
                        return; // Allow the newline
                    } else {
                        change.cancel(); // Prevent the newline
                        return;
                    }
                }
            }

            // Allow deletions only if they are complete lines
            if (change.origin === "+delete" || change.origin === "cut") {
                if (change.from.line !== change.to.line || // Multiple lines are being completely removed
                    (change.from.ch === 0 && change.to.ch === cm.getLine(change.from.line).length)) { // The whole line is being removed
                    return; // Allow line deletions
                } else {
                    change.cancel(); // Prevent partial line deletions
                }
            }

            // Handle normal typing and enforce no inline edits
            if (change.text[0] !== "\n" && change.from.line === change.to.line) {
                if (change.from.ch !== change.to.ch || (line.length !== 0 && line[change.from.ch - 1] !== ' ' && line[change.to.ch] !== ' ')) {
                    change.cancel(); // Prevent editing inside lines not at space boundaries
                }
            }
        });
    
        $('#upload-form').on('submit', function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            $.ajax({
                type: 'POST',
                url: '{{ url_for("upload_file") }}',
                data: formData,
                contentType: false,
                processData: false,
                success: function(data) {
                    myCodeMirror_small_segment.setValue(data);
                    myCodeMirror_big_segment.setValue(data);
                },
                error: function(response) {
                    console.error('Failed to process the file:', response.responseText);
                    alert('Failed to process the file.');
                }
            });
        });
    
        $('#save-button-small-segment').click(function() {
            var textContent = myCodeMirror_small_segment.getValue();
            $.ajax({
                type: 'POST',
                url: '{{ url_for("save_transcription_small_segment") }}',
                data: JSON.stringify({ text: textContent }),
                contentType: 'application/json;charset=UTF-8',
                success: function(response) {
                    alert('Transcription of small segment saved successfully.');
                },
                error: function() {
                    alert('Failed to save the transcription of small segment.');
                }
            });
        });
        $('#save-button-big-segment').click(function() {
            var textContent = myCodeMirror_big_segment.getValue();
            $.ajax({
                type: 'POST',
                url: '{{ url_for("save_transcription_big_segment") }}',
                data: JSON.stringify({ text: textContent }),
                contentType: 'application/json;charset=UTF-8',
                success: function(response) {
                    alert('Transcription of big segment saved successfully.');
                },
                error: function() {
                    alert('Failed to save the transcription of big segment.');
                }
            });
        });
    });
</script>
</body>
</html>
