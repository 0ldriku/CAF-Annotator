<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transcription Service</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.css">
<style>
    .CodeMirror {
        border: 1px solid #ccc;
        height: auto;
        width: 100%;
    }
    .CodeMirror-scroll {
        max-height: 300px;  /* Adjust height accordingly */
    }
</style>
</head>
<body>
<div class="navbar">NAV BAR</div>
<div class="container">
    <h1>Transcribe</h1>
    <h2>File Upload</h2>
    <p>Please upload the audio file</p>
    <form id="upload-form" enctype="multipart/form-data">
        <input type="file" name="audiofile" id="file-upload" accept="audio/*">
        <button type="submit">Upload and Transcribe</button>
    </form>
    <h2>Below is the transcription</h2>
    <p>Edit the segment by adding or deleting lines</p>
    <div id="editor"></div> <!-- Placeholder for CodeMirror -->
    <button id="save-button">Save and Next Step</button>
</div>
<div class="container">
    <h1>Step 2<h1>
</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.2/lib/codemirror.js"></script>
<script>
    $(document).ready(function() {
        var myCodeMirror = CodeMirror(document.getElementById('editor'), {
            value: 'The transcription will be displayed here once the process is complete.\n...', // Ensure there's an initial newline for a    cleaner experience
            mode: "plaintext",
            lineNumbers: true,
            lineWrapping: true
        });

        // Enforce modifications only at spaces or end of lines
        myCodeMirror.on('beforeChange', function(cm, change) {
            if (change.origin === "+input" || change.origin === "paste") {
                // Get the position and the line where the change is being made
                var line = cm.getLine(change.from.line);
                var charPos = change.from.ch;

                // Allow Enter only if it's at the end of a line or after a space
                if (change.text[0] === "\n") {
                    if (charPos === line.length || line[charPos - 1] === ' ') {
                        return; // Allow the newline
                    } else {
                        change.cancel(); // Prevent the newline
                        return;
                    }
                }
            }

            // Allow deletions only if they are complete lines
            if (change.origin === "+delete" || change.origin === "cut") {
                if (change.from.line !== change.to.line || // Multiple lines are being completely removed
                    (change.from.ch === 0 && change.to.ch === cm.getLine(change.from.line).length)) { // The whole line is being removed
                    return; // Allow line deletions
                } else {
                    change.cancel(); // Prevent partial line deletions
                }
            }

            // Handle normal typing and enforce no inline edits
            if (change.text[0] !== "\n" && change.from.line === change.to.line) {
                if (change.from.ch !== change.to.ch || (line.length !== 0 && line[change.from.ch - 1] !== ' ' && line[change.to.ch] !== ' ')) {
                    change.cancel(); // Prevent editing inside lines not at space boundaries
                }
            }
        });
    
        $('#upload-form').on('submit', function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            $.ajax({
                type: 'POST',
                url: '{{ url_for("upload_file") }}',
                data: formData,
                contentType: false,
                processData: false,
                success: function(data) {
                    myCodeMirror.setValue(data);
                },
                error: function(response) {
                    console.error('Failed to process the file:', response.responseText);
                    alert('Failed to process the file.');
                }
            });
        });
    
        $('#save-button').click(function() {
            var textContent = myCodeMirror.getValue();
            $.ajax({
                type: 'POST',
                url: '{{ url_for("save_transcription") }}',
                data: JSON.stringify({ text: textContent }),
                contentType: 'application/json;charset=UTF-8',
                success: function(response) {
                    alert('Transcription saved successfully.');
                },
                error: function() {
                    alert('Failed to save the transcription.');
                }
            });
        });
    });
</script>
</body>
</html>
